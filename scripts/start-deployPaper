#!/bin/bash

# shellcheck source=start-utils
. "${SCRIPTS:-/}start-utils"
set -o pipefail
handleDebugMode

: "${PAPER_PROJECT:=paper}"
: "${PAPER_BUILD:=${PAPERBUILD:-}}"
: "${PAPER_CHANNEL:=default}"
: "${PAPER_DOWNLOAD_URL:=}"
: "${PAPER_CUSTOM_JAR:=}"

# Default repository URL
DEFAULT_REPO="https://raw.githubusercontent.com/dayyeeet/minecraft-default-configs/main"
OPTIMIZED_REPO="https://raw.githubusercontent.com/Alpha018/paper-config-optimized/main"

# Check if PAPER_CONFIG_REPO is set and not empty
if [ -n "$PAPER_CONFIG_REPO" ]; then
  log "Download Default config from ${PAPER_CONFIG_REPO}"
  PAPER_CONFIG_DEFAULTS_REPO="$PAPER_CONFIG_REPO"
else
  PAPER_CONFIG_DEFAULTS_REPO="$DEFAULT_REPO"
fi

# Check if PAPER_OPTIMIZE is set to TRUE
if isTrue "${PAPER_OPTIMIZE}"; then
  log "Download Default config from Alpha018 Repo"
  PAPER_CONFIG_DEFAULTS_REPO="$OPTIMIZED_REPO"
fi

resultsFile=/data/.paper.env
if [[ $PAPER_CUSTOM_JAR ]]; then
  export SERVER="$PAPER_CUSTOM_JAR"
elif [[ $PAPER_DOWNLOAD_URL ]]; then
  if ! mc-image-helper install-paper \
    --output-directory=/data \
    --results-file="$resultsFile" \
    --url="$PAPER_DOWNLOAD_URL"; then
      log "ERROR: failed to download from custom PaperMC URL"
      exit 1
  fi
  # grab SERVER and export it
  set -a
  # shellcheck disable=SC1090
  source "${resultsFile}"
  set +a

else
  args=(
    --output-directory=/data
    --results-file="$resultsFile"
    --project="$PAPER_PROJECT"
    --version="$VERSION"
    --channel="$PAPER_CHANNEL"
  )
  if [[ $PAPER_BUILD ]]; then
    args+=(--build="$PAPER_BUILD")
  fi
  if ! mc-image-helper install-paper "${args[@]}"; then
      log "ERROR: failed to download $PAPER_PROJECT"
      exit 1
  fi
  # grab SERVER and export it
  set -a
  # shellcheck disable=SC1090
  source "${resultsFile}"
  set +a

fi

# Download default configs to allow for consistent patching
for c in paper-global.yml paper-world-defaults.yml spigot.yml; do
  DOWNLOAD_DEFAULT_CONFIGS+=",${PAPER_CONFIG_DEFAULTS_REPO}/${VERSION}/$c"
done
export DOWNLOAD_DEFAULT_CONFIGS

# Normalize on Spigot for downstream operations
export FAMILY=SPIGOT

exec "${SCRIPTS:-/}start-spiget" "$@"
